## 3. `config.yaml` 详细说明

## 3.1 完整示例

```yaml
listen: "127.0.0.1:8080"

# 可选：开启入站 HTTPS
# inbound_tls:
#   cert_path: "./certs/server.crt"
#   key_path: "./certs/server.key"
#   # 若不提供 cert/key，会自动使用下列自签名路径：
#   # 若文件存在则直接加载，不存在则自动生成
#   self_signed_cert_path: "./certs/gateway-selfsigned.crt"
#   self_signed_key_path: "./certs/gateway-selfsigned.key"

gateway_auth:
  tokens:
    - "${GW_TOKEN}" # 建议从环境变量注入
  token_sources:
    - type: "authorization_bearer"
    - type: "header"
      name: "x-gw-token"

routes:
  - id: "openai"
    prefix: "/openai"
    upstream:
      base_url: "https://api.openai.com"
      strip_prefix: true
      connect_timeout_ms: 10000
      request_timeout_ms: 60000
      # 可选：覆盖全局上游按 key 并发上限（每个 key）
      upstream_key_max_inflight: 8
      # 可选：按路由配置出站代理
      proxy:
        protocol: "http" # http | https | socks
        address: "127.0.0.1:7890"
        username: "${PROXY_USERNAME}"
        password: "${PROXY_PASSWORD}"
      inject_headers:
        - name: "authorization"
          value: "Bearer ${OPENAI_API_KEY}"
      remove_headers:
        - "authorization"
        - "x-forwarded-for"
        - "forwarded"
        - "cf-connecting-ip"
        - "true-client-ip"
      forward_xff: false

  - id: "anthropic"
    prefix: "/claude"
    upstream:
      base_url: "https://api.anthropic.com"
      strip_prefix: true
      connect_timeout_ms: 10000
      request_timeout_ms: 60000
      inject_headers:
        - name: "x-api-key"
          value: "${ANTHROPIC_API_KEY}"
        - name: "anthropic-version"
          value: "2023-06-01"
      remove_headers:
        - "authorization"
        - "x-api-key"
        - "x-forwarded-for"
        - "forwarded"
      forward_xff: false

cors:
  enabled: false
  allow_origins: []
  allow_headers: []
  allow_methods: []
  expose_headers: []

rate_limit:
  per_minute: 120

concurrency:
  downstream_max_inflight: 100
  upstream_per_key_max_inflight: 8

observability:
  logging:
    level: "info"
    format: "json" # json | text
    to_stdout: true
    file:
      enabled: true
      dir: "./logs"
      prefix: "ai-gw-lite"
      rotation: "daily" # minutely | hourly | daily | never
      max_files: 7
  metrics:
    enabled: true
    path: "/metrics"
    token: "${GW_METRICS_TOKEN}"
  tracing:
    enabled: true
    sample_ratio: 0.05
    otlp:
      endpoint: "http://127.0.0.1:4317"
      timeout_ms: 3000
```

### 3.2 顶层字段

| Key | 类型 | 必填 | 默认值 | 说明 |
| --- | --- | --- | --- | --- |
| `listen` | `string` | 是 | 无 | 网关监听地址，格式 `host:port`，如 `127.0.0.1:8080`。 |
| `inbound_tls` | `object` | 否 | `null` | 入站 HTTPS 配置；配置后网关使用 HTTPS 监听。 |
| `gateway_auth` | `object` | 是 | 无 | 入站鉴权配置。 |
| `routes` | `array` | 是 | 无 | 路由转发规则，至少 1 条。 |
| `cors` | `object` | 否 | `null` | 浏览器跨域配置（支持 preflight 与常规响应头注入）。 |
| `rate_limit` | `object` | 否 | `null` | 下游限流配置（固定窗口，分钟级）。 |
| `concurrency` | `object` | 否 | `null` | 并发保护配置（下游全局 + 上游按 route + key）。 |
| `observability` | `object` | 否 | `null` | 可观测性配置（结构化日志、metrics、tracing）。 |

### 3.3 `inbound_tls` 字段（可选）

| Key | 类型 | 必填 | 默认值 | 说明 |
| --- | --- | --- | --- | --- |
| `cert_path` | `string` | 否 | `null` | 证书文件路径（PEM）。 |
| `key_path` | `string` | 否 | `null` | 私钥文件路径（PEM）。 |
| `self_signed_cert_path` | `string` | 否 | `certs/gateway-selfsigned.crt` | 自签名证书文件路径。 |
| `self_signed_key_path` | `string` | 否 | `certs/gateway-selfsigned.key` | 自签名私钥文件路径。 |

规则：
- `cert_path` 与 `key_path` 要么同时配置，要么都不配置。
- 若同时配置，网关直接加载指定证书和私钥。
- 若都不配置，网关优先加载 `self_signed_*` 路径的现有文件；不存在时自动生成自签名证书并落盘。

### 3.4 `gateway_auth` 字段

| Key | 类型 | 必填 | 默认值 | 可选值/限制 | 说明 |
| --- | --- | --- | --- | --- | --- |
| `tokens` | `array<string>` | 是 | 无 | 至少 1 个，不能为空字符串 | 允许访问网关的 token 白名单。 |
| `token_sources` | `array<object>` | 否 | `[{"type":"authorization_bearer"}]` | 顺序生效 | 按顺序尝试提取 token。 |

`token_sources` 子项支持：

1. `{"type": "authorization_bearer"}`  
从 `Authorization: Bearer <token>` 提取。

2. `{"type": "header", "name": "x-gw-token"}`  
从指定 Header 提取（`name` 必填）。

### 3.5 `routes` 字段

每个 `route` 包含：

| Key | 类型 | 必填 | 默认值 | 可选值/限制 | 说明 |
| --- | --- | --- | --- | --- | --- |
| `id` | `string` | 是 | 无 | 全局唯一，非空 | 路由标识。 |
| `prefix` | `string` | 是 | 无 | 必须以 `/` 开头；除 `/` 外不能以 `/` 结尾；全局唯一 | 路由前缀。 |
| `upstream` | `object` | 是 | 无 | - | 上游转发配置。 |

#### 路由匹配规则
- 最长前缀优先（`/openai/v1` 优先于 `/openai`）
- 路径段边界匹配：
  - `/openai` 匹配 `/openai` 和 `/openai/...`
  - `/openai` 不匹配 `/openai2/...`

### 3.6 `upstream` 字段

| Key | 类型 | 必填 | 默认值 | 可选值/限制 | 说明 |
| --- | --- | --- | --- | --- | --- |
| `base_url` | `string` | 是 | 无 | 非空，建议完整 URL（`https://...`） | 上游基地址。 |
| `strip_prefix` | `bool` | 否 | `true` | `true/false` | 是否从请求路径中移除 `prefix` 后再拼接。 |
| `connect_timeout_ms` | `u64` | 否 | `10000` | `> 0` | 建立上游连接超时。 |
| `request_timeout_ms` | `u64` | 否 | `60000` | `> 0` | 请求总预算（详见超时语义）。 |
| `inject_headers` | `array<object>` | 否 | `[]` | Header 名和值需合法 | 注入到上游请求；同名会覆盖。 |
| `remove_headers` | `array<string>` | 否 | `[]` | 大小写不敏感 | 转发前移除的请求头。 |
| `forward_xff` | `bool` | 否 | `false` | `true/false` | 是否保留/传递 `x-forwarded-for` 等来源 IP 头。 |
| `proxy` | `object` | 否 | `null` | 协议为 `http/https/socks` | 按路由配置 gateway 到上游的出站代理。 |
| `upstream_key_max_inflight` | `usize` | 否 | `null` | `> 0` | 覆盖全局上游按 route + key 并发上限（每个 key）。 |

#### `inject_headers` 子项

| Key | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| `name` | `string` | 是 | 要注入的 header 名。 |
| `value` | `string` | 是 | 要注入的 header 值。 |

示例：

```yaml
inject_headers:
  - name: "authorization"
    value: "Bearer ${OPENAI_API_KEY}"
```

#### `proxy` 子项（可选）

| Key | 类型 | 必填 | 默认值 | 说明 |
| --- | --- | --- | --- | --- |
| `protocol` | `string` | 是 | 无 | 代理协议：`http` / `https` / `socks`。 |
| `address` | `string` | 是 | 无 | 代理地址，格式 `host:port`。 |
| `username` | `string` | 否 | `null` | 代理认证用户名。 |
| `password` | `string` | 否 | `null` | 代理认证密码。 |

约束：
- `username` 与 `password` 必须同时出现或同时省略。
- 建议通过 `${ENV_VAR}` 注入代理凭据，避免明文。

### 3.7 `cors` 字段

`cors.enabled=true` 时，网关会：
- 处理 `OPTIONS` preflight 请求并返回 CORS 响应头
- 在普通响应（包括错误响应）中注入 `Access-Control-Allow-Origin`

| Key | 类型 | 默认值 | 说明 |
| --- | --- | --- | --- |
| `enabled` | `bool` | `false` | 是否启用 CORS。 |
| `allow_origins` | `array<string>` | `[]` | 允许的来源列表，建议填写完整 origin（如 `https://fy.ciallo.fans`）。 |
| `allow_headers` | `array<string>` | `[]` | preflight 允许的请求头。 |
| `allow_methods` | `array<string>` | `[]` | preflight 允许的请求方法。 |
| `expose_headers` | `array<string>` | `[]` | 暴露给浏览器 JS 的响应头。 |

说明：
- `allow_origins` 支持 `*`。
- 为兼容存量配置，`allow_origins` 也接受不带协议的 host（如 `fy.ciallo.fans`），请求时会回写真实 `Origin`。

### 3.8 `rate_limit` 字段（可选）

| Key | 类型 | 默认值 | 说明 |
| --- | --- | --- | --- |
| `per_minute` | `u64` | 无 | 每分钟允许的请求数（`> 0`）。 |

行为：
- 作用于下游请求（client -> gateway）。
- 维度为 `token + route`。
- 超限返回 `429 {"error":"rate_limited"}`，并带 `Retry-After`。

### 3.9 `concurrency` 字段（可选）

| Key | 类型 | 默认值 | 说明 |
| --- | --- | --- | --- |
| `downstream_max_inflight` | `usize` | `null` | 下游全局并发上限（`> 0`）。 |
| `upstream_per_key_max_inflight` | `usize` | `null` | 上游按 route + key 并发上限（`> 0`）。 |

行为：
- `downstream_max_inflight` 超限返回 `503 {"error":"downstream_concurrency_exceeded"}`。
- `upstream_per_key_max_inflight` 超限返回 `503 {"error":"upstream_concurrency_exceeded"}`。
- 上游 key 只来源于 YAML：`routes[].upstream.inject_headers[].value`（不读取客户端请求头）。
- 识别的 key header 固定为：`authorization`、`x-api-key`（按该顺序匹配）。
- `routes[].upstream.upstream_key_max_inflight` 可覆盖全局上游并发上限。

### 3.10 `observability` 字段（可选）

#### `logging` 子项

| Key | 类型 | 默认值 | 说明 |
| --- | --- | --- | --- |
| `level` | `string` | `"info"` | 日志级别过滤器（如 `info`、`debug`）。 |
| `format` | `string` | `"json"` | 日志格式：`json` 或 `text`。 |
| `to_stdout` | `bool` | `true` | 是否继续输出到控制台。 |

#### `logging.file` 子项（可选）

| Key | 类型 | 默认值 | 说明 |
| --- | --- | --- | --- |
| `enabled` | `bool` | `true` | 是否启用文件日志。 |
| `dir` | `string` | `"logs"` | 日志目录（不存在会自动创建）。 |
| `prefix` | `string` | `"ai-gw-lite"` | 文件名前缀。 |
| `rotation` | `string` | `"daily"` | 分片滚动策略：`minutely` / `hourly` / `daily` / `never`。 |
| `max_files` | `usize` | `7` | 最多保留的分片文件数量（`> 0`）。 |

#### `metrics` 子项

| Key | 类型 | 默认值 | 说明 |
| --- | --- | --- | --- |
| `enabled` | `bool` | `false` | 是否启用 metrics 端点。 |
| `path` | `string` | `"/metrics"` | metrics 端点路径，必须以 `/` 开头，且不能是 `/healthz`。 |
| `token` | `string` | `""` | metrics 访问 token；`enabled=true` 时必须非空。 |

#### `tracing` 子项

| Key | 类型 | 默认值 | 说明 |
| --- | --- | --- | --- |
| `enabled` | `bool` | `false` | 是否启用 tracing。 |
| `sample_ratio` | `f64` | `0.05` | 采样率，范围 `[0.0, 1.0]`。 |
| `otlp.endpoint` | `string` | `null` | OTLP 导出地址（可选）。 |
| `otlp.timeout_ms` | `u64` | `3000` | OTLP 导出超时毫秒（`> 0`）。 |

行为说明：
- `/metrics` 仅使用独立 metrics token 鉴权，不复用 `GW_TOKEN`。
- `/metrics/summary` 同样使用 metrics token 鉴权。
- `/metrics/ui` 为内置只读页面；页面通过 JS 周期拉取 `/metrics/summary`。
- 代理请求响应会自动附带 `x-request-id`（可透传客户端提供值，或自动生成）。
- 指标标签仅使用低基数字段（`route_id`、`method`、`outcome` 等），不包含 path/query/token。
- `logging.file.enabled=true` 时日志会持久化到文件，并按 `rotation` 自动滚动分片；启动时会按 `max_files` 清理旧分片。

### 3.11 环境变量插值规则 `${ENV_NAME}`

- 配置文件中出现 `${ENV_NAME}` 会在加载时替换为系统环境变量值。
- 若环境变量不存在，启动失败。
- 建议所有密钥（如 `GW_TOKEN`、上游 API key）都通过环境变量注入。

示例（Linux/macOS）：

```bash
export GW_TOKEN="your_gw_token"
export GW_METRICS_TOKEN="your_metrics_token"
export OPENAI_API_KEY="sk-..."
```

示例（Windows PowerShell）：

```powershell
$env:GW_TOKEN="your_gw_token"
$env:GW_METRICS_TOKEN="your_metrics_token"
$env:OPENAI_API_KEY="sk-..."
```

提示：
- 某些包含反斜杠的值（如 Windows 路径）建议用单引号包裹，避免 YAML 转义干扰。